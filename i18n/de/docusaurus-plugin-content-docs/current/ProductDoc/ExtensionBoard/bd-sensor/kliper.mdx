---
sidebar_position: 3
sidebar_label: Verwendung von Klipper
---


import ImageView from '@site/src/components/ImageView';


# Installation von **BDsensor**

## Verbinden Sie das Sensorkabel mit dem Hauptboard oder der CAN-Bus-Werkzeugkopfplatte.

    * Bitte beachten Sie, dass SB2040 nicht mit dem BDsensor verwendet werden kann.
    * Bitte beachten Sie, dass SHT36 den CLK/SCL (Input) des BDsensors an einen Hochspannungseingang anschließen und den Jumper verbinden muss.
    * Die CKL- und SDA-Leitungen des BDsensors können an jeden GPIO-Pin der Platine angeschlossen werden. Sie können das BDsensor-Kabel auch direkt an den Bltouch-Port anschließen, z.B.:

    ```bash
    BLtouch    |    BDsensor
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Input)
    GND      -->     GND
    Zmin     -->     SDA    (Input/Output) 
    ```

    * Da einige Pins in den Anschlüssen des Hauptboards möglicherweise nicht direkt mit den GPIOs des MCUs verbunden sind (z.B. durch Filterkondensatoren, MOSFETs, Dioden oder Optokoppler isoliert, aber durch Widerstände oder Widerstände mit Pull-Up/Pull-Down isoliert), können sie nicht mit dem BDsensor verwendet werden. Das Firmware wird eine Verbindungsfehlermeldung ausgeben. Zum Beispiel:

    * Die Anschlüsse für Ventilatoren und Heizkörper sind durch MOSFETs isoliert.
    * In einigen Platinen sind die Anschlüsse für Temperatursensoren und Endanschläge/Proben normalerweise durch Filterkondensatoren mit GND verbunden.

1. Installieren Sie den BDsensor wie in der Abbildung gezeigt in der Nähe der Heißkammer. [STL of mount](https://www.thingiverse.com/thing:6098131),  [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/bd-sensor/img/bd.png').default} size="100%" align="left" />


## Installieren Sie das Patch in die Klipper-Firmware

    * Verwerfen Sie zuvor geänderte Klipper-Dateien und aktualisieren Sie Klipper

        ```bash
        cd
        cd ~/klipper
        git checkout .
        git pull
        ```

    * Klonen Sie den neuesten Code des BDsensors

        ```bash
        cd && git clone https://github.com/markniu/Bed_Distance_sensor.git
        ```

    * Installation

        ```bash
        cd  ~/Bed_Distance_sensor/klipper/
        ./install_BDsensor.sh
        ```

    * Kompilieren Sie die Firmware

        ```bash
        cd ~/klipper/
        make menuconfig
        make clean
        make
        ```

    * Laden Sie die Firmware auf das MCU oder die CANbus-Werkzeugkopfplatte, die mit dem BDsensor verbunden ist

## Wenn Ihr Drucker mit Moonraker läuft, fügen Sie den folgenden Abschnitt zu moonraker.conf hinzu, dann können Sie den BDsensor mit einem Klick über die Webseite oder Klipperscreen aktualisieren.

    ```bash
    [update_manager BDsensor]
    type: git_repo
    primary_branch: new
    channel: dev
    path: ~/Bed_Distance_sensor
    origin: https://github.com/markniu/Bed_Distance_sensor.git
    install_script: ./klipper/install_BDsensor.sh
    is_system_service: False
    managed_services: klipper
    info_tags:
    desc=Bed Distance Sensor
    ```

## Bearbeiten Sie die printer.cfg

    * Kopieren Sie diesen Abschnitt in Ihre **printer.cfg** und bearbeiten Sie die `sda_pin` und `scl_pin` in `[BDsensor]`, vergessen Sie nicht, andere Probenabschnitte wie **BLtouch** zu deaktivieren. Sie können den BDsensor an das Hauptboard oder an das Werkzeugkopf-CAN-Modul anschließen.
    * Ändern Sie in `[BDsensor]` die `speed` auf 0.8. Dies gilt nur für die Befehle Z-Schräge und PROBE_ACCURACY. Ein niedrigerer Wert bedeutet eine höhere Genauigkeit beim Sondieren, da der MCU nicht in Echtzeit wie ein normaler Endschalter den BDsensor im Hauptkreis liest.
    * Um den BDsensor als Endschalter beim Z-Achsen-Homing zu verwenden, ändern Sie in `[stepper_z]` `endstop_pin` zu `endstop_pin: probe:z_virtual_endstop`
    * Stellen Sie sicher, dass in **printer.cfg** `[safe_z_home]` enthalten ist.
    * Ändern Sie in `[bed_mesh]` und `[z_tilt]` oder `[quad_gantry_level]` den Wert von `[quad_gantry_level]` auf 1 (empfohlen 0.7-1.0mm), da der Standardwert von Klipper 5mm beträgt, was den Sensorbereich überschreiten könnte.
    * **Die Düsenhöhe sollte nur in `z_adjust:` eingestellt werden. Positive Werte nähern sich dem Bett an, negative Werte entfernen sich vom Bett. Andere Einstellungen zur Anpassung der Düsenhöhe könnten Fehler verursachen.**
    * Um die schnelle Bettsondierung zu aktivieren, entfernen Sie das `#` vor `no_stop_probe:true`.
    * Hier ist ein Beispiel für eine Konfiguration.

        ```cfg
        [BDsensor] 
        scl_pin:PC6  # Servo-Signal-Port
        sda_pin:PC3  # Endschalter-Signal-Port
        delay: 20 # 20us pro Impuls, dieser Wert sollte >=20 sein, aber darf nicht 50 überschreiten
        z_offset:0 # Dieser `z_offset` muss auf 0 gesetzt werden.
        z_adjust:0.0 # Z-Achsen-Anpassung, ersetzt die Funktion von z_offset. Innerhalb von -0.3 bis 0.3mm
        x_offset: -34
        y_offset: 0
        #no_stop_probe:true # Aktivieren Sie dies für schnelle Sondierung, der Werkzeugkopf wird nicht an der Sondierstelle anhalten.
        position_endstop: 0.8 # Die Z-Achse wird bei dieser Position (mm) während des Homings angehalten, empfohlener Wert ist 0.4~1.0
        #speed:0.8 # Diese Geschwindigkeit gilt nur für den Z-Schrägungs- und PROBE_ACCURACY-Befehl.

        [stepper_z]
        endstop_pin: probe:z_virtual_endstop 
        #position_endstop: 0.5
        homing_speed: 5
        second_homing_speed: 0.8

        [bed_mesh]
        speed: 200
        horizontal_move_z:1
        algorithm: bicubic

        [quad_gantry_level]
        horizontal_move_z:1

        ```

## Nach der Installation prüfen Sie bitte durch das Senden der folgenden G-Code-Befehle

    ```bash
    M102   S-1     # Sensoreninformationen lesen
    M102   S-2     # Einen Entfernungswert lesen
    ```

## Prüfen Sie die Verbindung

    * Senden Sie `M102 S-1` über die **Konsole**, dies ist ein Beispiel für die Rückmeldung. Wenn es leer oder eine andere Zeichenkette zurückgibt, überprüfen Sie die Verbindung und die Reihenfolge der Drähte.

        ```bash
        Send: M102 S-1
        Recv: V1.0 pandapi3d.com
        ```

## Kalibrierung

    * Reinigen Sie die Düse und bewegen Sie die Z-Achse über die Konsole, bis die Düse gerade den Bett berührt (der BDsensor wird diese Position als Nullposition verwenden, daher ist kein `z_offset` erforderlich, das ist der Grund, warum der Wert in `[BDsensor]` auf 0 steht)
    * Senden Sie den G-Code-Befehl `M102 S-6` über die **Konsole**, der Drucker bewegt die Z-Achse langsam um 0.1mm nach oben, bis er 4mm erreicht. Führen Sie M102 S-6 nicht vor der Installation des Sensors aus und schalten Sie während der Kalibrierung nicht den Drucker aus, sonst werden die alten Kalibrierungsdaten gelöscht. In diesem Fall müssen Sie nur erneut kalibrieren.
    * Danach können Sie überprüfen, ob der BDsensor erfolgreich kalibriert wurde, indem Sie `M102 S-5` senden, das die gespeicherten Rohkalibrierungsdaten des BDsensors zurückgibt.

**Hinweise**:

* Die Homing-Geschwindigkeit der Z-Achse sollte am besten 5 sein.

* Wenn `M102 S-5` den ersten Rohkalibrierungswert größer als 400 zurückgibt, bedeutet das, dass der Sensor zu hoch installiert ist und näher am Bett montiert werden muss. Der empfohlene Wert für den ersten Datenpunkt ist 100. Stellen Sie außerdem sicher, dass der Wert des zweiten Datenpunkts mehr als 10 über dem ersten Datenpunkt liegt.

  * FAQ: Was bedeutet es, wenn die Kalibrierungsdaten mit 1 beginnen, der zweite Wert 9 ist und der dritte Wert 24?

  * Das bedeutet, dass die Auflösung zwischen 0-0.1 mm nur 9 beträgt, während die Auflösung zwischen 0.1-0.2 mm 15 ist. Es wird empfohlen, erneut zu kalibrieren, damit die erste Auflösung 0-0.1 mm größer als 10 ist.

* Vergessen Sie nicht, nach dem Ausführen von G28 oder vor den Befehlen `Z_tilt` und `quad_gantry_level` die Höhe der Z-Achse anzupassen.

* Die Teilnamen müssen korrekt groß- und kleingeschrieben sein, sonst meldet Klipper `Unknown pin chip name 'probe'`.
