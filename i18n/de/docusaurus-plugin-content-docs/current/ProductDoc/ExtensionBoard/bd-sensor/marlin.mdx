---
sidebar_position: 3
sidebar_label: Marlin-Nutzung
---


import ImageView from '@site/src/components/ImageView';


# Installation von **BDsensor**

## Verbinden Sie das Sensorkabel mit dem Hauptboard oder der CAN-Bus-Werkzeugkopfplatte.

    * Beachten Sie, dass SB2040 nicht mit BDsensor verwendet werden kann
    * Beachten Sie, dass für den SHT36 der CLK/SCL (Input) des BDsensors an den Hochspannungseingang angeschlossen werden muss und der Jumper aufgesetzt sein muss
    * Die CKL- und SDA-Leitungen des BDsensors können an beliebige GPIO-Pins der Platine angeschlossen werden. Sie können das BDsensor-Kabel auch direkt an den Bltouch-Anschluss anschließen, zum Beispiel:

    ```bash
    BLtouch    |    BDsensor
    5V       -->     5V
    GND      -->     GND
    S        -->     CLK/SCL    (Input)
    GND      -->     GND
    Zmin     -->     SDA    (Input/Output) 
    ```

    * Da einige Pins im Hauptboard-Steckverbinder möglicherweise nicht direkt mit den GPIOs des MCUs verbunden sind (z.B. sie könnten Filterkondensatoren haben oder über MOSFETs, Dioden oder Optokoppler isoliert sein, aber wenn sie durch Widerstände oder Widerstand-Pull-up/Pull-down isoliert sind, können sie verwendet werden), können sie nicht zusammen mit dem BDsensor verwendet werden. Und die Firmware meldet einen Verbindungsfehler. Zum Beispiel

    * Ventilatoren und Heizkörperanschlüsse sind über MOSFETs isoliert,
    * Einige Platinen haben für Temperatur-NTCs und Endstops/Sondenanschlüsse, die normalerweise über Filterkondensatoren mit GND verbunden sind,

1. Installieren Sie den BDsensor wie in der Abbildung gezeigt in der Nähe des Heißends. [STL of mount](https://www.thingiverse.com/thing:6098131), [STL_mount_VzBot_Goliath short](https://discord.com/channels/829828765512106054/1163237892957671424)

    <ImageView image={require('@site/docs/ProductDoc/ExtensionBoard/bd-sensor/img/bd.png').default} size="100%" align="left" />



## Installieren Sie das Patch in die Marlin-Firmware

    Der BDsensor ist in Marlin2.1.x integriert (seit dem 27.08.2022),

    Sie können die veröffentlichte Version herunterladen. Aber jetzt wird empfohlen, die neueste Fehlerbehebung herunterzuladen: https://github.com/MarlinFirmware/Marlin

    Sie müssen die Konfigurationsdatei und die Pin-Datei ändern.

### Bearbeiten Sie die Konfigurationsdatei .h

1. Aktivieren Sie BD_SENSOR

    Kommentierung aufheben

    ```bash
    #define BD_SENSOR
    #define Z_SAFE_HOMING
    #define BD_SENSOR_PROBE_NO_STOP // Hinzufügen dieser neuen Zeile für schnelles Einstellen des Betts ohne Düsenstopp
    ```

    Nur `BD_SENSOR_PROBE_NO_STOP`

    Neueste Marlin-Fehlerbehebung: https://github.com/MarlinFirmware/Marlin

    Beschreibung: https://github.com/MarlinFirmware/Marlin/pull/25847

2. Homing mit Sonde

    Stellen Sie sicher, dass Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN deaktiviert ist und aktivieren Sie `USE_PROBE_FOR_Z_HOMING` wie unten gezeigt:

    ```bash
    //#define Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN
    // Force the use of the probe for Z-axis homing
    #define USE_PROBE_FOR_Z_HOMING
    ```

3. Verlangsamen Sie die Geschwindigkeit des zweiten Homing Z

    ```bash
    #define Z_PROBE_FEEDRATE_SLOW (Z_PROBE_FEEDRATE_FAST / 16)
    ```

    Hier müssen wir die Geschwindigkeit des Homing und des Z-Homing verlangsamen, da der Stopper, der vom BDsensor-Prozess gelesen wird, nicht so zeitnah wie ein normaler Stopper ist.

    ### Bearbeiten Sie die Configuration_adv.h

    Aktivieren Sie `#define BABYSTEPPING` für die Echtzeit-Ebeneinstellungsfunktion

    ```bash
    #define HOMING_BUMP_DIVISOR { 2, 2, 8 }       // Re-Bump Speed Divisor (Divides the Homing Feedrate)
    ```

### Bearbeiten Sie pins_boardname.h

    Konfigurieren Sie die SDA- und SCL-Pins des BDsensors in der Pin-Datei pins_boardname.h, indem Sie die folgenden 3 Zeilen hinzufügen (zum Beispiel): `pins_PANDA_PI_V29.h`

        ```bash
        #define  I2C_BD_SDA_PIN    PC6   // Bitte ändern Sie dies auf die tatsächliche Nummer, an die das SDA-Kabel an Ihrem Hauptboard angeschlossen ist
        #define  I2C_BD_SCL_PIN    PB2   // Bitte ändern Sie dies auf die tatsächliche Nummer, an die das SLK-Kabel an Ihrem Hauptboard angeschlossen ist
        #define  I2C_BD_DELAY  20      // Standardwert ist 20, sollte im Bereich [20,50] liegen.
        ```

    Wenn Sie wie bei einem normalen BLtouch vor dem Drucken eine automatische Bettnivellierungssonde (G29) durchführen möchten, heben Sie die Kommentierung auf:

        ```bash
        #define AUTO_BED_LEVELING_BILINEAR
        ```

    Und bearbeiten Sie die folgenden Werte wie unten gezeigt:

        ```bash
        #define Z_CLEARANCE_DEPLOY_PROBE   0 // Z Clearance for Deploy/Stow
        #define Z_CLEARANCE_BETWEEN_PROBES  1 // Z Clearance between probe points
        #define Z_CLEARANCE_MULTI_PROBE     1 // Z Clearance between multiple probes
        ```

## Anzeige des BDsensor-Wertes auf dem LCD-Bildschirm

    * Für Drucker mit Statusanzeige (unterstützt G-Code M117), wie LCD12864 oder einige UART-Bildschirme, wie Ender3V2 ...

## Kalibrierung

    1. Reinigen Sie die Düse und bewegen Sie die Z-Achse über die Konsole, bis die Düse gerade den Druckbett berührt (der BDsensor wird diese Position als Nullpunkt verwenden, daher ist kein z_offset erforderlich, wir setzen den Wert auf 0).
    2. Senden Sie den G-Code-Befehl `M102 S-6`, der Drucker bewegt die Z-Achse langsam nach oben um 0.1mm, bis er 4mm erreicht. Führen Sie M102 S-6 nicht aus, bevor der Sensor installiert ist, und schalten Sie den Drucker während der Kalibrierung nicht aus, sonst werden die alten Kalibrierungsdaten gelöscht. In diesem Fall müssen Sie nur die Kalibrierung wiederholen.

    3. Sie können `M102 S-5` senden, um zu überprüfen, ob der BDsensor erfolgreich kalibriert wurde, was die gespeicherten Rohdaten der Kalibrierung zurückgibt.

    Es gibt auch ein Kalibrierungstool, das dies kann: https://github.com/markniu/Bed_Distance_sensor/raw/new/marlin/BD_Config_Tool_Marlin.zip ![img](https://raw.githubusercontent.com/markniu/Bed_Distance_sensor/main/doc/images/Read.jpg)

    Hinweis: Ein Datenwert von 1015 oder > 1010 bedeutet, dass der Sensor außerhalb des Bereichs ist. Wenn die ersten 5 Punkte (0~0.5mm) oder mehr innerhalb des Bereichs 0 bis 1000 liegen und der Delta-Wert der Zunahme >=10 ist, ist die Kalibrierung erfolgreich. Wie in der obigen Tabelle dargestellt.

    Wenn der erste Rohdatenwert von M102 S-5 größer als 400 ist, bedeutet das, dass der Sensor zu hoch installiert ist und näher am Bett neu installiert werden muss. Stellen Sie außerdem sicher, dass der zweite Datenwert um mehr als 10 größer ist als der erste.

## Test und Druck

    Menü Bettschicht

    Automatische Bettnivellierung

## Es gibt zwei Methoden zur automatischen Nivellierung des Bettes:

    **1. Verwenden Sie M102 für die Echtzeit-Nivellierung der ersten Schichten**

        Wir können dies einfach durch Senden des G-Code-Befehls oder durch Hinzufügen des G-Codes zur G-Code-Datei aktivieren oder deaktivieren.

        Um die Bettnivellierung in Cura zu aktivieren, fügen Sie den G-Code `M102 S2` in den Abschnitt "Start G-Code" der Drucker-Maschinen-Einstellungen unter G102 (Home alle Achsen) hinzu. Zum Beispiel, unter G28, bedeutet dies, dass die Bettnivellierung nur bei einer Z-Achsenhöhe von unter 0.2mm durchgeführt wird.

        Senden oder hinzufügen des BDsensors zur Deaktivierung der Bettnivellierung, was standardmäßig deaktiviert ist. `M102 S0``G28``M18`

        ```bash
        M102   S-1     // Lesen der Sensorinformationen, dies kann zur Überprüfung der Verbindung verwendet werden.
        M102   S-2     // Lesen des aktuellen Abstandswerts
        M102   S-5     // Lesen der Rohdaten der Kalibrierung
        M102   S-6     // Start der Kalibrierung, stellen Sie sicher, dass die Düse gerade das Bett berührt, bevor Sie dies tun, und starten Sie den Drucker neu. Homing der Z-Achse nicht vor diesem Schritt.
        M102   S4      // Setzen des anpassbaren Z-Höhenwerts, z.B. M102 S4 bedeutet, dass die Anpassung durchgeführt wird, wenn die Z-Höhe <=0.4mm ist, deaktivieren Sie es mit M102 S0.
        ```

    **2. G29 Automatische Bettnivellierung**

        Eine weitere Methode zur automatischen Nivellierung des Bettes ist ähnlich wie bei G29 für BLtouch, fügen Sie einfach eine Zeile G28 unter G29 hinzu.

        [Installationsvideo](https://www.pandapi3d.com/post/install-bed-distance-sensor-video)

        [Chris Basement Installationsvideo](https://youtu.be/VLUfvkO2NFc?si=PF_6nhw39KhHBhcj)

### Überprüfen des Z-Endstopps `M119`

    Überprüfen Sie diesen Schritt nicht vor dem Homing der Z-Achse, da die Düse sonst das Druckbett berühren könnte.

    Dies ist die Rückmeldung nach dem Senden des Befehls M119 (Bericht über den Endstoppstatus).

    ```bash
    Send: M119
    Recv: x:open y:open z:open
    ```

    Wenn z min nicht offen ist, überprüfen Sie Ihre Konfiguration. `#define Z_MAX_ENDSTOP_HIT_STATE HIGH`

    - Stellen Sie sicher, dass der Z-Motor ausgeschaltet/entriegelt ist
    - Bewegen Sie die Z-Achse manuell nach unten, bis die Düse das Bett berührt
    - Senden Sie `M102 S-2`, der zurückgegebene Wert sollte 0.00mm sein, und senden Sie dann erneut M119, um zu sehen, dass der Z-Endstopp jetzt ausgelöst ist.

    ```bash
    Send: M119
    Recv: x:open y:open z:TRIGGERED
    ```

    ### Überprüfen der Verbindung

    Überprüfen Sie die Verbindung mit `M102 S-1`. Dies ist ein Beispiel für die Rückmeldung, bitte überprüfen Sie, ob die Verbindung und die Reihenfolge der Drähte leer oder eine andere Zeichenkette zurückgibt.

    ```bash
    Send: M102 S-1
    Recv: V1.0 pandapi3d.com
    ```

## Wenn alle oben genannten Schritte korrekt sind, können Sie jetzt die Z-Achse nach Hause fahren.

